# LingoCard — Anchor State File

---

## CURRENT STATE

* Проект **LingoCard (lingocard-next)** находится в рабочем состоянии: приложение запускается через `index.html → js/main.js`.
* Используется модульная архитектура ES Modules.
* Инициализация проходит через `preflight()` с проверкой контракта (`js/contract.js`).
* Контракт определяет обязательные модули и их exports; считается источником истины.
* Основной контроллер приложения — `js/app/app.js` (монолит).
* Состояние хранится в LocalStorage, автосейв активен.
* Рендер карточек осуществляется через `js/render/renderCard.js` (canvas, autofit).
* UI реализован через `js/ui/uiShell.js` + `uiCore.js` + `ui/features/*`.
* AI Control Panel подключается лениво (dynamic import) из папки `ai/`.
* Экспорт PDF работает, preview совпадает с PDF.

---

## ACTIVE TASKS

1. Введение якорной системы состояния проекта (этот файл).
2. Проверить миграции/нормализацию на реальных сохранениях (старый autosave → старт без ошибок → повторный старт без повторной миграции).
3. Анализ причин исчезновения AI-панели при взаимодействии с UI.
4. Подготовка архитектурного плана декомпозиции `js/app/app.js`.

---

## NEXT PLANS

* Ввести `state.schemaVersion` и централизованную систему миграций.
* Разделить `app.js` на логические модули (state / history / controllers / init).
* Очистить проект от legacy/неиспользуемых файлов или вынести их в `legacy/`.
* Усилить smoke-test (Normal / Full / Paranoid режимы).
* Зафиксировать FILEMAP.md как часть релизного контракта.

---

## KNOWN ISSUES / RISKS

* `DEFAULTS.boxes` содержит элементы без поля `text`, что может вызывать ошибки рендера и автофита.
* Дублирующиеся вызовы `ensureLabelKeysEverywhere` и `syncCurrentToCards` усложняют отладку.
* Файл `js/app/state.js` представляет собой параллельный state-менеджер и является потенциальной миной.
* Использование `innerHTML` с данными (например, в verbs list) может ломать DOM и логику UI.
* Наличие неясных / полу-legacy файлов снижает предсказуемость поведения приложения.

---

## CHANGE HISTORY

## 2026-02-05 — AI Control Panel: RU/EN verb input + Utilities: open browser on server start

### Что изменено
- AI Control Panel: поле **Infinitiv** теперь принимает глаголы на **русском** или **английском** (best-effort): перед генерацией панель пытается перевести ввод в **немецкий инфинитив** через LM Studio, затем запускает обычную генерацию.
  - Работает и для batch‑режима (список через запятую/пробел/кавычки и импорт из файла).
- Utilities: при выборе пункта **«Запуск локального сервера»** автоматически открывается браузер по умолчанию на `http://127.0.0.1:8080/` (или на fallback‑port при запуске python http.server).

### Затронутые файлы
- `ai/ai.entry.js`
- `help/help_ru.html`, `help/help_en.html`, `help/help_de.html`
- `_utilities/ps/server_run.ps1`

## 2026-02-04 — AI Control Panel: multiple infinitives in one input

### Что изменено
- Поле **Инфинитив** теперь принимает **не один**, а **несколько** инфинитивов:
  - разделители: запятая/точка с запятой/перенос строки **или пробел**;
  - для составных глаголов поддержаны **кавычки**: например, "Rad fahren" "spazieren gehen".
- При вводе списка и нажатии **Сгенерировать** запускается **batch-генерация** (по одному глаголу подряд) с тем же пайплайном, что и импорт из файла.
- Обновлены placeholder-и (ru/de/en), чтобы это поведение было видно пользователю.

### Затронутые файлы
- `ai/ai.entry.js`
- `ai/ai.i18n.js`

## 2026-02-04 — AI Control Panel: ghost clipping fix + animated stopwatch + 5mm panel padding

### Что изменено
- Исправлено **обрезание подсказки** в поле инфинитива (ghost completion): подсказка больше не режется снизу.
- Значок секундомера заменён на **анимированный циферблат** со стрелкой (0s = 12 часов, 30s = 6 часов).
- Добавлен внутренний отступ **5mm** для содержимого панели, чтобы визуальные рамки сверху вниз выглядели ровно.

### Затронутые файлы
- `ai/ai.verbs.autocomplete.js`
- `ai/ai.entry.js`
- `ai/ai.styles.css`

## 2026-02-04 — AI Control Panel: cleaner generator row + progress indicator

### Что изменено
- Кнопка **Сгенерировать** перенесена в строку ввода инфинитива (слева), чтобы генерация была "под рукой".
- Кнопки **Validate JSON** и **Apply** убраны из верхнего ряда (теперь это **автомат**):
  - после генерации карточки в правом списке — валидация запускается как и раньше автоматически;
  - после **Fix** патч **применяется автоматически**, если валидация patchedBoxes OK.
- Переименован индикатор списка: **"Результат появится в правом списке"**.
- Добавлен "механический" значок секундомера **⏱** слева от таймера.
- Индикатор‑"иллюминатор":
  - **красный по умолчанию**;
  - во время запроса циклически проходит **красный → оранжевый → жёлтый → зелёный** (цикл **30s**);
  - после успешного добавления глагола в правый список — **плавно становится зелёным** на короткое время.

### Затронутые файлы
- `ai/ai.entry.js`
- `ai/ai.styles.css`
- `ai/ai.i18n.js`

## 2026-02-04 — Autocomplete infinitives in AI Generator input

### Что добавлено
- Добавлен **автодополнитель инфинитивов** в поле Infinitiv в AI Control Panel:
  - подсказка «ghost completion» прямо в поле ввода;
  - принятие подсказки клавишами **Tab** и **→ (ArrowRight)**;
  - **Enter** по‑прежнему запускает Generate (как раньше).
- Добавлена **автокоррекция перед Generate**: если введён только префикс и есть подходящее дополнение — поле автоматически дополняется до валидного инфинитива.
- В проект добавлен статический словарь инфинитивов `ai/data/verbs_infinitive.txt`.

### Затронутые файлы
- `ai/ai.entry.js`
- `ai/ai.verbs.autocomplete.js`
- `ai/data/verbs_infinitive.txt`
- `FILEMAP.md`

- 2026-02-01: Внедрены `schemaVersion` и единый пайплайн миграций/нормализации `state` (boxes) при старте; исправлены дефолтные boxes без `text`, убраны дубли миграций в init.
* 2026-02-01: Создан якорный файл LC_ANCHOR.md. Зафиксировано текущее состояние проекта, активные задачи, планы и риски.

---
## 2026-02-02 — Canonical Full template + missing boxes migration

### Что исправлено
- Встроен **канонический шаблон Full** (из `styles/preset_Full.json`) как единый источник правды для геометрии и набора блоков.
- Добавлена миграция **ensureCanonicalBoxes()**:
  - гарантирует наличие ключевых блоков (`freqCorner`, `inf`, `tr`, `forms`, `syn`, `rek`, `examples`, `pref`) в `state.boxes` и `state.sourceBoxes`;
  - чинит legacy bind'ы (`tr→translationsLine`, `forms→formsLine`, `syn→synonymsPairsBlock`, `examples→examplesBlock`, `rek→rektionBlock`);
  - скрывает устаревшие раздельные блоки примеров (`exPr/exPt/exPf`), чтобы интерфейс не выглядел «а чё это?».
- Для отладки в консоли добавлены алиасы:
  - `window.LC` (как и раньше),
  - `window.app` (привычка `app.state...`),
  - `window.state` (быстрый просмотр состояния).

### Зачем
Левая колонка (канон) и правая (черновик) должны опираться на одинаковый набор блоков и одинаковую систему bind'ов. Ранее у части состояний блок `rek` отсутствовал в `state.boxes`, из‑за этого «жёлтая рамка/блок рекции» мог не обновляться или оставаться пустым.

### Затронутые файлы
- `js/app/app.js`
- `LC_ANCHOR.md`

